{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>User Profile - DocuTrackr</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="icon" type="image/png" href="{% static 'images/docutrackr-logo.png' %}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="{% static 'css/profile.css' %}">
</head>
<body>
  <header class="navbar">
    <div class="navbar-left">
      <a href="{{ home_url }}"><img src="{% static 'images/logo.png' %}" alt="DocuTrackr Logo" class="logo" /></a>
      <nav>
        <ul>
          <li><a href="{{ home_url }}" class="active">Home</a></li>
          <li><a href="{% url 'about' %}">About</a></li>
          <li><a href="{% url 'create_request' %}">Create Request</a></li>
          <li><a href="{% url 'student-requests' %}">Requests</a></li>
        </ul>
      </nav>
    </div>
    <div class="navbar-right">
      {% if full_name %}
        <a href="{{ home_url }}" class="user-name">{{ full_name }}</a>
      {% else %}
        <span class="user-name"></span>
      {% endif %}
      <div class="navbar-icons">
        <!-- ðŸ”” Notification Dropdown Wrapper -->
        <div class="notification-wrapper">
            <div class="icon-item notification-icon" id="notifBtn">
              <img src="{% static 'images/bell.png' %}" alt="Notification Bell">
            </div>
            <!-- ðŸ”½ DROPDOWN -->
            <div class="notification-dropdown" id="notifDropdown">
              <h4>Notifications</h4>

              <div class="notif-list"></div>

              <button class="mark-read-btn">Mark all as read</button>
            </div>
        </div>
        <a href="{% url 'profile' %}" class="icon-item profile-icon">
          <img src="{% static 'images/Profile.png' %}" alt="User Profile" />
        </a>
        <a href="{% url 'student_logout' %}" class="icon-item logout-icon">
          <img src="{% static 'images/logout.png' %}" alt="Logout" />
        </a>
      </div>
    </div>
  </header>

  <div class="profile-container">
    <div class="profile-header">
      <div class="profile-header-content">
        <div class="profile-avatar-wrapper">
          <div class="profile-avatar">
            <i class="fas fa-user"></i>
          </div>
        </div>
        <h1>Personal Information</h1>
        <p class="profile-subtitle">Manage and update your account details</p>
      </div>
    </div>

    <div class="profile-sections">
      <!-- Full Name Card -->
      <div class="profile-card">
        <div class="card-icon-wrapper">
          <div class="card-icon name-icon">
            <i class="fas fa-user-circle"></i>
          </div>
        </div>
        <div class="card-inner">
          <div class="card-header">
            <h2 class="card-title">Full Name</h2>
          </div>
          <div class="card-content">
            <p class="info-value">{{ student_name|default:"Alex Martinez" }}</p>
          </div>
        </div>
      </div>

      <!-- Email Card -->
      <div class="profile-card">
        <div class="card-icon-wrapper">
          <div class="card-icon email-icon">
            <i class="fas fa-envelope"></i>
          </div>
        </div>
        <div class="card-inner">
          <div class="card-header">
            <h2 class="card-title">Email Address</h2>
          </div>
          <div class="card-content">
            <p class="info-value">{{ email|default:"alex.martinez@citu.edu" }}</p>
          </div>
        </div>
      </div>

      <!-- Password Card -->
      <div class="profile-card">
        <div class="card-icon-wrapper">
          <div class="card-icon password-icon">
            <i class="fas fa-lock"></i>
          </div>
        </div>
        <div class="card-inner">
          <div class="card-header">
            <h2 class="card-title">Password</h2>
            <div class="header-actions">
              <button class="edit-btn" id="changePasswordHeader" data-section="password">Change</button>
              <div id="saveCancelHeader" class="header-save-cancel" style="display:none;">
                <button type="button" class="edit-btn primary" id="savePasswordHeader">Save</button>
                <button type="button" class="edit-btn outline" id="cancelPasswordHeader">Cancel</button>
              </div>
            </div>
          </div>
          <div class="card-content">
            <p class="info-value password-value">â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢</p>
            <form id="passwordForm" class="password-form" style="display:none;">
              <div class="password-grid">
                <div>
                  <div class="form-row">
                    <label class="info-label" for="oldPassword">Current Password <span class="required-star">*</span></label>
                    <div class="input-with-toggle">
                      <input type="password" id="oldPassword" class="input-field" placeholder="Enter current password" />
                      <button type="button" class="toggle-password" data-target="oldPassword">Show</button>
                    </div>
                    <div class="error-msg" id="err-oldPassword"></div>
                  </div>
                  <div class="form-row">
                    <label class="info-label" for="newPassword">New Password <span class="required-star">*</span></label>
                    <div class="input-with-toggle">
                      <input type="password" id="newPassword" class="input-field" placeholder="Enter new password" />
                      <button type="button" class="toggle-password" data-target="newPassword">Show</button>
                    </div>
                    <div class="error-msg" id="err-newPassword"></div>
                  </div>
                  <div class="form-row">
                    <label class="info-label" for="confirmPassword">Confirm New Password <span class="required-star">*</span></label>
                    <div class="input-with-toggle">
                      <input type="password" id="confirmPassword" class="input-field" placeholder="Confirm new password" />
                      <button type="button" class="toggle-password" data-target="confirmPassword">Show</button>
                    </div>
                    <div class="error-msg" id="err-confirmPassword"></div>
                  </div>
                </div>
                <div>
                  <div class="requirements-card">
                    <div class="requirements-title">Password Requirements</div>
                    <ul class="req-list">
                      <li id="req-length" class="req-item invalid"><span class="req-dot"></span>At least 8 characters</li>
                      <li id="req-uppercase" class="req-item invalid"><span class="req-dot"></span>At least 1 uppercase letter (Aâ€“Z)</li>
                      <li id="req-number" class="req-item invalid"><span class="req-dot"></span>At least 1 number (0â€“9)</li>
                      <li id="req-special" class="req-item invalid"><span class="req-dot"></span>At least 1 special character (! @ # $ %)</li>
                    </ul>
                  </div>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <footer class="footer">
    <div class="footer-content">
      <div class="footer-section">
        <h4>DocuTrackr</h4>
        <p>Simplifying document requests for CIT-U students.</p>
      </div>
      <div class="footer-section">
        <h4>Quick Links</h4>
        <ul>
          <li><a href="{% url 'student-dashboard' %}">Home</a></li>
          <li><a href="{% url 'about' %}">About</a></li>
          <li><a href="#">Privacy Policy</a></li>
          <li><a href="#">Contact</a></li>
        </ul>
      </div>
      <div class="footer-section">
        <h4>Support</h4>
        <ul>
          <li><a href="#">Help Center</a></li>
          <li><a href="#">FAQ</a></li>
          <li><a href="#">Report Issue</a></li>
          <li><a href="#">Feedback</a></li>
        </ul>
      </div>
    </div>
    <div class="footer-bottom">
      <p>&copy; 2025 DocuTrackr. All rights reserved. | CIT-U Document Management System</p>
    </div>
  </footer>

  <div id="successToast" class="success-toast">Password changed successfully!</div>

  <script src="{% static 'js/profile.js' %}"></script>
  <script>
  const notifBtn = document.getElementById("notifBtn");
  const notifDropdown = document.getElementById("notifDropdown");

  function getCSRFToken() {
    const cookies = document.cookie ? document.cookie.split(';') : [];
    for (let cookie of cookies) {
      const [name, value] = cookie.trim().split('=');
      if (name === 'csrftoken') return value;
    }
    return '';
  }

  if (notifBtn && notifDropdown) {
    notifBtn.addEventListener("click", () => {
      const isOpen = notifDropdown.style.display === "block";
      notifDropdown.style.display = isOpen ? "none" : "block";

      if (!isOpen) {
        fetch("/notifications/api/fetch/", { credentials: "include" })
          .then(res => {
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            const ct = res.headers.get("content-type");
            if (!ct || !ct.includes("application/json")) throw new Error("Not JSON");
            return res.json();
          })
          .then(data => {
            let notifList = notifDropdown.querySelector(".notif-list");
            if (!notifList) {
              notifList = document.createElement('div');
              notifList.className = 'notif-list';
              const markBtn = notifDropdown.querySelector('.mark-read-btn');
              if (markBtn) notifDropdown.insertBefore(notifList, markBtn);
              else notifDropdown.appendChild(notifList);
            }
            notifList.innerHTML = "";

            if (!data || !Array.isArray(data.notifications) || data.notifications.length === 0) {
              notifList.innerHTML = `<div class=\"notif-item\">No notifications yet</div>`;
              let showAllBtn = notifDropdown.querySelector(".show-all-btn");
              if (showAllBtn) showAllBtn.remove();
              return;
            }

            data.notifications.forEach(n => {
              const readClass = n.is_read ? "" : "unread";
              const msg = n.message || '';
              const time = n.time || '';
              notifList.innerHTML += `
                <div class=\"notif-item ${readClass}\">
                  <p>${msg}</p>
                  <span class=\"time\">${time}</span>
                </div>
              `;
            });

            let showAllBtn = notifDropdown.querySelector(".show-all-btn");
            if (!showAllBtn) {
              showAllBtn = document.createElement('a');
              showAllBtn.className = 'show-all-btn';
              showAllBtn.href = '/notifications/all/';
              showAllBtn.textContent = 'Show all';
              const markBtn = notifDropdown.querySelector('.mark-read-btn');
              if (markBtn) notifDropdown.insertBefore(showAllBtn, markBtn);
              else notifDropdown.appendChild(showAllBtn);
            }
          })
          .catch(() => {
            let notifList = notifDropdown.querySelector(".notif-list");
            if (!notifList) {
              notifList = document.createElement('div');
              notifList.className = 'notif-list';
              const markBtn = notifDropdown.querySelector('.mark-read-btn');
              if (markBtn) notifDropdown.insertBefore(notifList, markBtn);
              else notifDropdown.appendChild(notifList);
            }
            notifList.innerHTML = `<div class=\"notif-item\">Error loading notifications. Please refresh.</div>`;
          });
      }
    });

    const markReadBtn = notifDropdown.querySelector(".mark-read-btn");
    if (markReadBtn) {
      markReadBtn.addEventListener("click", () => {
        fetch("/notifications/api/mark-read/", {
          method: "POST",
          credentials: "include",
          headers: { "X-CSRFToken": getCSRFToken(), "Content-Type": "application/json" }
        })
        .then(res => {
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const ct = res.headers.get("content-type");
          if (!ct || !ct.includes("application/json")) throw new Error("Not JSON");
          return res.json();
        })
        .then(() => {
          document.querySelectorAll(".notif-item.unread").forEach(i => i.classList.remove("unread"));
        })
        .catch(() => {});
      });
    }

    document.addEventListener("click", (e) => {
      if (!notifBtn.contains(e.target) && !notifDropdown.contains(e.target)) {
        notifDropdown.style.display = "none";
      }
    });
  }
  </script>
</body>
</html>
