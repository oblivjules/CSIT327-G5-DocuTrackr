{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DocuTrackr - Request Document</title>
  <link rel="stylesheet" href="{% static 'css/style-request_form.css' %}">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="icon" type="image/png" href="{% static 'images/docutrackr-logo.png' %}">
</head>
<body>
  <header class="navbar">
    <div class="navbar-left">
      <a href="{{ home_url }}"><img src="{% static 'images/logo.png' %}" alt="DocuTrackr Logo" class="logo" /></a>
      <nav>
        <ul>
          <li><a href="{{ home_url }}">Home</a></li>
          <li><a href="{% url 'about' %}">About</a></li>
          <li><a href="{% url 'create_request' %}" class="active">Create Request</a></li>
          <li><a href="{% url 'student-requests' %}">Requests</a></li>
        </ul>
      </nav>
    </div>

    <div class="navbar-right">
      {% if full_name %}
        <a href="{{ home_url }}" class="user-name">{{ full_name }}</a>
      {% else %}
        <span class="user-name"></span>
      {% endif %}

      <div class="navbar-icons">
        <div class="notification-wrapper">
          <div class="icon-item notification-icon" id="notifBtn">
            <img src="{% static 'images/bell.png' %}" alt="Notification Bell" />
            <span class="notification-badge" id="notifBadge">...</span>
          </div>
          <div class="notification-dropdown" id="notifDropdown">
            <h4>Notifications</h4>
            <div class="notif-list"></div>
            <button class="mark-read-btn">Mark all as read</button>
          </div>
        </div>

        <a href="{% url 'profile' %}" class="icon-item profile-icon">
          <img src="{% static 'images/Profile.png' %}" alt="User Profile" />
        </a>

        <a href="{% url 'student_logout' %}" class="icon-item logout-icon">
          <img src="{% static 'images/logout.png' %}" alt="Logout" />
        </a>
      </div>
    </div>
  </header>

  <div class="container">
    <div class="request-form">
      <div class="form-header">
        <div class="form-icon">
          <img src="{% static 'images/folder.png' %}" alt="Request Icon" class="header-icon" />
        </div>
        <div>
          <h2>Request a New Document</h2>
          <p>Please fill out the form to request a document from the Registrar's Office.</p>
        </div>
      </div>

      <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="form-grid">
          <div class="form-group">
            <label for="studentId" class="required">
              <img src="{% static 'images/user.png' %}" alt="Student ID Icon" class="input-icon" />
              Student ID
            </label>
            <input type="text" id="studentId" name="student_id" value="{{ student_id }}" readonly required>
          </div>

          <div class="form-group">
            <label for="studentName" class="required">
              <img src="{% static 'images/id-card.png' %}" alt="Student Name Icon" class="input-icon" />
              Student Name
            </label>
            <input type="text" id="studentName" name="student_name" value="{{ full_name }}" readonly required>
          </div>
         
          <div class="form-group">
            <label for="docType" class="required">
              <img src="{% static 'images/doc.png' %}" alt="Document Type Icon" class="input-icon" />
              Select Document Type
            </label>
            <select id="docType" name="document_type" required>
              <option value="">-- Select Document Type --</option>
              {% for doc in documents %}
                <option value="{{ doc.name }}" {% if document_type == doc.name %}selected{% endif %}>
                  {{ doc.name }}
                </option>
              {% empty %}
                <option disabled>No documents available</option>
              {% endfor %}
            </select>
          </div>

          <div class="form-group">
            <label for="dateNeeded">
              <img src="{% static 'images/datepicker.png' %}" alt="Date Picker Icon" class="input-icon" />
              Date Needed By
            </label>
            <input type="date" id="dateNeeded" name="date_needed" value="{{ date_needed|default:'' }}" required>
          </div>

          <div class="form-group">
            <label for="copies" class="required">
              <img src="{% static 'images/copy.png' %}" alt="Copies Icon" class="input-icon" />
              Number of Copies
            </label>
            <input type="number" id="copies" name="copies" min="1" value="{{ copies|default:'' }}" placeholder="1" required>
          </div>

          <div class="file-upload">
            <div class="upload-icon">
              <img src="{% static 'images/upload.png' %}" alt="Upload Icon" />
            </div>
            <p class="upload-title">Proof of Payment Upload</p>
            <p class="upload-subtitle">Upload your payment receipt here</p>
            <input type="file" id="fileInput" name="proof_of_payment" accept=".png,.jpg,.jpeg,.svg,.webp">
            <label for="fileInput" class="file-label">Choose File</label>
            <p class="upload-info">Supported formats: PNG, JPG, JPEG, SVG, WEBP</p>
          </div>

          {% if success %}
            <script>
              window.addEventListener("load", () => {
                setTimeout(() => {
                  alert("{{ success|escapejs }}");
                }, 100);
              });
            </script>
          {% endif %}

          <div class="submit-btn">
            <button type="submit">
              Submit Request
              <img src="{% static 'images/submit.png' %}" alt="Submit Icon" class="submit-icon" />
            </button>
          </div>
        </div>
      </form>
    </div>

    <div class="history">
      <div class="history-header">
        <img src="{% static 'images/history.png' %}" alt="History Icon" class="history-icon" />
        <h3>Request History</h3>
      </div>

          <div class="table-wrapper">
        <table class="history-table">
          <colgroup>
            <col style="width:85px;" />
            <col style="width:220px;" />
            <col style="width:60px;" />
            <col style="width:110px;" />
            <col style="width:125px;" />
            <col style="width:110px;" />
            <col style="width:130px;" />
          </colgroup>
          <thead>
            <tr>
              <th>Request ID</th>
              <th>Document</th>
              <th>Copies</th>
              <th>Date Needed</th>
              <th>Status</th>
              <th>Payment</th>
              <th>Claim Slip</th>
            </tr>
          </thead>
          <tbody>
            {% for req in user_requests %}
              <tr>
                <td><span class="request-id">REQ-{{ req.request_id }}</span></td>
                <td>{{ req.document.name }}</td>
                <td>{{ req.copies }}</td>
                <td>{{ req.date_needed|date:"M d, Y" }}</td>
                <td><span class="status-badge status-{{ req.status }}">{{ req.status|title }}</span></td>

                <td>
                  {% if req.payment %}
                    <div style="display:flex;align-items:center;gap:8px;margin-left: 10px;">
                      {% if req.payment and req.payment.proof_of_payment %}
                        <button class="view-proof-btn" data-request-id="{{ req.request_id }}" data-img-url="{{ req.payment.proof_of_payment }}">
                          <img src="{% static 'images/media.png' %}" alt="View Proof" width="30" />
                        </button>
                      {% endif %}
                    </div>
                  {% else %}
                    <span style="color:#999;">No Payment</span>
                  {% endif %}
                </td>

                <td>
                  {% if req.claim_slips.exists %}
                    {% if req.status == 'approved' or req.status == 'completed' %}
                      {% with slip=req.claim_slips.first %}
                      <a href="{% url 'claim-slip' slip.claim_id %}" class="action-btn claim-slip-btn">Claim Slip</a>
                      {% endwith %}
                    {% else %}
                      <span style="color:#999;">Not Available</span>
                    {% endif %}
                  {% else %}
                    <span style="color:#999;">Not Available</span>
                  {% endif %}
                </td>
              </tr>
            {% empty %}
              <tr><td colspan="6" style="text-align:center;">No requests found.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="proofModal" class="modal" style="display:none;">
    <div class="modal-content">
      <span class="close-btn">&times;</span>
      <img id="proofImage" src="" alt="Proof of Payment" />
    </div>
  </div>

  <footer class="footer">
    <div class="footer-content">
      <div class="footer-section">
        <h4>DocuTrackr</h4>
        <p>Simplifying document requests for CIT-U students.</p>
      </div>
      
      <div class="footer-section">
        <h4>Quick Links</h4>
        <ul>
          <li><a href="{{ home_url }}">Home</a></li>
          <li><a href="{% url 'about' %}">About</a></li>
          <li><a href="#">Privacy Policy</a></li>
          <li><a href="#">Contact</a></li>
        </ul>
      </div>
      
      <div class="footer-section">
        <h4>Support</h4>
        <ul>
          <li><a href="#">Help Center</a></li>
          <li><a href="#">FAQ</a></li>
          <li><a href="#">Report Issue</a></li>
          <li><a href="#">Feedback</a></li>
        </ul>
      </div>
    </div>
    
    <div class="footer-bottom">
      <p>&copy; 2025 DocuTrackr. All rights reserved. | CIT-U Document Management System</p>
    </div>
  </footer>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const dateInput = document.getElementById('dateNeeded');
  if (dateInput) {
    const today = new Date().toISOString().split('T')[0];
    dateInput.setAttribute('min', today);
  }

  const form = document.querySelector('form');
  const fileInput = document.getElementById('fileInput');
  const fileLabel = document.querySelector('.file-label');
  const allowedTypes = ['image/png', 'image/jpeg', 'image/svg+xml', 'image/webp'];

  let errorContainer = document.querySelector('.file-upload .form-error');
  if (!errorContainer && fileInput) {
    errorContainer = document.createElement('p');
    errorContainer.className = 'form-error';
    errorContainer.style.color = 'red';
    errorContainer.style.fontWeight = 'bold';
    fileInput.parentNode.appendChild(errorContainer);
  }

  if (fileInput) {
    fileInput.addEventListener('change', () => {
      errorContainer.textContent = '';
      const file = fileInput.files[0];

      if (!file) {
        errorContainer.textContent = 'Proof of payment is required.';
        fileLabel.textContent = 'Choose File';
        return;
      }

      if (!allowedTypes.includes(file.type)) {
        errorContainer.textContent = 'Unsupported file format. Supported: PNG, JPG, SVG, WEBP.';
        fileInput.value = '';
        fileLabel.textContent = 'Choose File';
        return;
      }

      fileLabel.textContent = file.name;
    });
  }

  if (form) {
    form.addEventListener('submit', (e) => {
      const file = fileInput?.files[0];
      errorContainer.textContent = '';

      if (!file) {
        e.preventDefault();
        errorContainer.textContent = 'Proof of payment is required.';
        return false;
      }

      if (!allowedTypes.includes(file.type)) {
        e.preventDefault();
        errorContainer.textContent = 'Unsupported file format. Supported: PNG, JPG, SVG, WEBP.';
        return false;
      }
    });
  }

  // ðŸ”¹ FIXED MODAL PROOF VIEWER
  const modal = document.getElementById("proofModal");
  const modalImg = document.getElementById("proofImage");
  const closeBtn = document.querySelector(".close-btn");

  const proofButtons = document.querySelectorAll(".view-proof-btn");

  proofButtons.forEach((btn) => {
    btn.addEventListener("click", () => {
      let imgUrl = btn.getAttribute("data-img-url");

      if (!imgUrl) {
        alert("No proof of payment available.");
        return;
      }

      // âœ… FIX: Don't prepend '/' for Supabase URLs
      modalImg.src = imgUrl.startsWith("http") ? imgUrl : "/" + imgUrl;

      modalImg.onload = () => {
        modal.style.display = "flex";
        document.body.style.overflow = "hidden";
      };

      modalImg.onerror = () => {
        console.error("Failed to load proof image:", imgUrl);
        alert("Unable to display image. Please check if the proof file exists.");
      };
    });
  });

  closeBtn?.addEventListener("click", () => {
    modal.style.display = "none";
    modalImg.removeAttribute("src");
    document.body.style.overflow = "auto";
  });

  modal.addEventListener("click", (e) => {
    if (e.target === modal) {
      modal.style.display = "none";
      modalImg.removeAttribute("src");
      document.body.style.overflow = "auto";
    }
  });
});


    const notifBtn = document.getElementById("notifBtn");
    const notifDropdown = document.getElementById("notifDropdown");
    const notifBadge = document.getElementById("notifBadge");

    // Fetch unread count on page load
    function updateNotificationBadge() {
        fetch("/notifications/api/fetch/", { credentials: "include" })
            .then(res => {
                if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                const contentType = res.headers.get("content-type");
                if (!contentType || !contentType.includes("application/json")) {
                    throw new Error("Response is not JSON");
                }
                return res.json();
            })
            .then(data => {
                const unreadCount = data.notifications ? data.notifications.filter(n => !n.is_read).length : 0;
                if (notifBadge) {
                    if (unreadCount > 0) {
                        notifBadge.textContent = unreadCount > 99 ? "99+" : unreadCount;
                        notifBadge.classList.remove("hide");
                    } else {
                        notifBadge.classList.add("hide");
                    }
                }
            })
            .catch(err => {
                console.error('Failed to fetch notification count:', err);
                if (notifBadge) notifBadge.classList.add("hide");
            });
    }

    // Update badge on page load
    updateNotificationBadge();

    // Refresh badge every 30 seconds
    setInterval(updateNotificationBadge, 30000);

    function getCSRFToken() {
        const cookies = document.cookie ? document.cookie.split(';') : [];
        for (let cookie of cookies) {
            const [name, value] = cookie.trim().split('=');
            if (name === 'csrftoken') return value;
        }
        return '';
    }

    if (notifBtn && notifDropdown) {
        notifBtn.addEventListener("click", () => {
            const isOpen = notifDropdown.style.display === "block";
            notifDropdown.style.display = isOpen ? "none" : "block";

            if (!isOpen) {
                fetch("/notifications/api/fetch/", { credentials: "include" })
                    .then(res => {
                        if (!res.ok) {
                            throw new Error(`HTTP error! status: ${res.status}`);
                        }
                        // Check if response is JSON
                        const contentType = res.headers.get("content-type");
                        if (!contentType || !contentType.includes("application/json")) {
                            throw new Error("Response is not JSON");
                        }
                        return res.json();
                    })
                    .then(data => {
                        let notifList = notifDropdown.querySelector(".notif-list");

                        if (!notifList) {
                            notifList = document.createElement('div');
                            notifList.className = 'notif-list';

                            const markBtn = notifDropdown.querySelector('.mark-read-btn');
                            if (markBtn) notifDropdown.insertBefore(notifList, markBtn);
                            else notifDropdown.appendChild(notifList);
                        }

                        notifList.innerHTML = "";

                        if (!data || !Array.isArray(data.notifications) || data.notifications.length === 0) {
                            notifList.innerHTML = `<div class="notif-item">No notifications yet</div>`;
                            // Remove show all button if it exists
                            const showAllBtn = notifDropdown.querySelector(".show-all-btn");
                            if (showAllBtn) showAllBtn.remove();
                            return;
                        }

                        data.notifications.forEach(n => {
                            const readClass = n.is_read ? "" : "unread";
                            notifList.innerHTML += `
                                <div class="notif-item ${readClass}">
                                    <p>${n.message}</p>
                                    <span class="time">${n.time}</span>
                                </div>
                            `;
                        });

                        // Add "Show all" button if notifications exist
                        let showAllBtn = notifDropdown.querySelector(".show-all-btn");
                        if (!showAllBtn) {
                            showAllBtn = document.createElement('a');
                            showAllBtn.className = 'show-all-btn';
                            showAllBtn.href = '/notifications/all/';
                            showAllBtn.textContent = 'Show all';
                            const markBtn = notifDropdown.querySelector('.mark-read-btn');
                            if (markBtn) {
                                notifDropdown.insertBefore(showAllBtn, markBtn);
                            } else {
                                notifDropdown.appendChild(showAllBtn);
                            }
                        }
                    })
                    .catch(err => {
                        console.error('Failed to fetch notifications:', err);
                        let notifList = notifDropdown.querySelector(".notif-list");
                        if (!notifList) {
                            notifList = document.createElement('div');
                            notifList.className = 'notif-list';
                            const markBtn = notifDropdown.querySelector('.mark-read-btn');
                            if (markBtn) notifDropdown.insertBefore(notifList, markBtn);
                            else notifDropdown.appendChild(notifList);
                        }
                        notifList.innerHTML = `<div class="notif-item">Error loading notifications. Please refresh.</div>`;
                    });
            }
        });

        const markReadBtn = notifDropdown.querySelector(".mark-read-btn");
        if (markReadBtn) {
            markReadBtn.addEventListener("click", () => {
                fetch("/notifications/api/mark-read/", {
                    method: "POST",
                    credentials: "include",
                    headers: {
                        "X-CSRFToken": getCSRFToken(),
                        "Content-Type": "application/json"
                    }
                })
                    .then(res => {
                        if (!res.ok) {
                            throw new Error(`HTTP error! status: ${res.status}`);
                        }
                        const contentType = res.headers.get("content-type");
                        if (!contentType || !contentType.includes("application/json")) {
                            throw new Error("Response is not JSON");
                        }
                        return res.json();
                    })
                    .then(() => {
                        document.querySelectorAll(".notif-item.unread")
                            .forEach(i => i.classList.remove("unread"));
                        // Update badge after marking as read
                        updateNotificationBadge();
                    })
                    .catch(err => {
                        console.error('Failed to mark notifications read:', err);
                    });
            });
        }

        document.addEventListener("click", (e) => {
            if (!notifBtn.contains(e.target) && !notifDropdown.contains(e.target)) {
                notifDropdown.style.display = "none";
            }
        });
    }
</script>
</body>
</html>
